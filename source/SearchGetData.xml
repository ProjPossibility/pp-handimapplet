<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs
	title="Parking Search"
	description="Displays a Hello World message in the left panel"
	author="Your name"
	author_email="your-email@gmail.com"
	height="150">
	<Require feature="sharedmap" />
</ModulePrefs>

<Content type="html">
<![CDATA[

<b>Handicapped Parking Finder</b><br/>
<small>
by <a target="_blank" href="http://www.projectpossibility.org/">Project:Possibility</a>
<br/><br/>
</small>
<div>
	<div style="background-color: #e5ecf9;">
	<style>
	.headertable{padding:0px 5px 5px 5px;width:300px;}
	.headerrow{font-size:8pt;padding:0px 0px 0px 5px;}
	.disabled{color:gray;}
	</style>
	<form onsubmit="doSearch(); return false;" style="margin-bottom: 4px; padding: 0px; border:0px">
		<table border=0 cellspacing="0" cellpadding="0" class="headertable">
			<tr class="headerrow">
				<td colspan=2>Zip Code</td>
			</tr>
			<tr>
				<td><input id="zipcode" name="zipcode" value="" style="width: 180px"></td>
			</tr>
			<tr class="headerrow">
				<td colspan=2>Keywords</td>
			</tr>
			<tr>
				<td>
					<select id="category" name="category"onchange="changeCategory(this.value);">
						<option value="" selected>Any</option>
						<option value="Entertainment">Entertainment</option>
						<option value="Food">Food</option>
						<option value="Government Facility">Government Facilities</option>
						<option value="Medical">Medical</option>
						<option value="Office">Office</option>
						<option value="Recreation">Recreation</option>
						<option value="School">School</option>
						<option value="Shopping">Shopping</option>
						<option value="Other">Other</option>
					</select>
				</td>
				<td><input type=submit value="Search"></td>
			</tr>
		</table>
	</form>
</div>
<div id="resultsheader"></div>

<script>
var map = new GMap2();
var markers = [];
var geocoder = new GClientGeocoder();
var targetDiv = document.getElementById("resultsheader");
var selectedCategory = "";

function centerAddress(address)
{
	geocoder.getLatLngAsync(address,
		function(latlng)
		{
			if (!latlng)
			{
				alert(address + " not found");
			}
			else
			{
				map.setCenter(latlng, 14);
			}
		}
	);
}

function markAddress(address, infoWindow)
{
	geocoder.getLatLngAsync(address,
		function(latlng)
		{
			if (!latlng)
			{
				alert(address + " not found");
			}
			else
			{
				var markerimg = "http://ss12.info/image/sponsor/logo_projpos_large.jpg";
				var icon = new GIcon(G_DEFAULT_ICON, markerimg);
				icon.iconSize=new GSize(25,25);
				icon.iconAnchor=new GPoint(14,40);
				icon.shadowSize=new GSize(0, 0);
				var marker = new GMarker(latlng, {icon:icon});
				markers.push(marker);
				map.addOverlay(marker);
				GEvent.addListener(marker, "click",
					function()
					{
						marker.openInfoWindowHtml(infoWindow);
					}
				);
			}
		}
	);
}

function doSearch()
{
	targetDiv.innerHTML="";
	markers = [];
	var zip= document.getElementById('zipcode').value;
	centerAddress(zip);
	map.clearOverlays();
	getLocations(zip);
}

function getLocations(zip)
{
	var url = "http://projectpossibility.org/svn/handicapmapplet/source/data.xml";
	_IG_FetchXmlContent(url,
		function(response)
		{
			var listings = [];
			var locations = response.getElementsByTagName("location");
			for(var i = 0 ; i < locations.length; i++)
			{
				var location = locations.item(i);
				if(location.getAttribute("zip") == zip)
				{
					listings.push(location);
					var contents= formatInfoWindow(location);
					markAddress(contents[0], contents[1]);
				}
			}
			displayListings(listings);
		},
	{refreshInterval:0});
}

function formatInfoWindow(location)
{
	var zip = location.getAttribute("zip");
	var streetNum = location.getAttribute("streetNum");
	var street = location.getAttribute("street");
	var city= location.getAttribute("city");
	var state = location.getAttribute("state");
	var address = streetNum + " " + street + " " + city + " " + state + " " + zip;
	var name = location.firstChild.nodeValue;
	var numSpaces = 0;
	var html = "<small><b>" +
		name + "</b><br/>" +
		streetNum + " " + street + ", " +
		city + ", " + state + " " + zip + "<br/>" +
		"<i>Handicap Parking Spaces: " + numSpaces +
		"</i><br/></small>";
	var returnResults= new Array();
	returnResults[0] = address;
	returnResults[1] = html;
	return returnResults;
}

function displayListings(listings)
{
	if(!listings || listings.length==0)
	{
		targetDiv.innerHTML += "<small><b>Sorry, nothing found.</b></small>";
	}
	else
	{
		targetDiv.innerHTML += "<small><b>Found " + listings.length +
							   " results.</b></small><br/><br/>";
		for(var i = 0 ; i < listings.length ; i++)
		{
			var listing = formatInfoWindow(listings[i]);
			targetDiv.innerHTML +=
				"<a href=\"#\" onclick=\"showInfoWindow(" + i + ", " +
				listing[1] + "); return false;\" >" + listing[1] +
				"</a><br/>";
		}
	}
}

function showInfoWindow(index, html)
{
	try {
		GEvent.trigger(markers[index], "click");
	} catch(error) {
		alert("Error in showInfoWindow(): " + error);
	}
}

function changeCategory(value)
{
	selectedCategory=value;
}
</script>

]]>
</Content>
</Module>
